Jenkins pipeline
-----------------------


node('maven') {
   // define commands
   def mvnCmd = "mvn -s configuration/cicd-settings.xml"
   stage ('Build') {
     git branch: 'eap-7', url: 'http://gogs:3000/gogs/openshift-tasks.git'
     sh "${mvnCmd} clean install -DskipTests=true"
   }

   stage ('Test and Analysis') {
     parallel (
         'Test': {
             sh "${mvnCmd} test"
             step([$class: 'JUnitResultArchiver', testResults: '**/target/surefire-reports/TEST-*.xml'])
         },
         'Static Analysis': {
             sh "${mvnCmd} jacoco:report sonar:sonar -Dsonar.host.url=http://sonarqube:9000 -DskipTests=true"
         }
     )
   }

   stage ('Push to Nexus') {
    sh "${mvnCmd} deploy -DskipTests=true"
   }

   stage ('Deploy DEV') {
     sh "rm -rf oc-build && mkdir -p oc-build/deployments"
     sh "cp target/openshift-tasks.war oc-build/deployments/ROOT.war"
     sh "oc project aarellano-dev"
     // clean up. keep the image stream
     sh "oc delete bc,dc,svc,route -l app=tasks -n aarellano-dev"
     // create build. override the exit code since it complains about exising imagestream
     sh "oc new-build --name=tasks --image-stream=jboss-eap70-openshift --binary=true --labels=app=tasks -n aarellano-dev || true"
     // build image
     sh "oc start-build tasks --from-dir=oc-build --wait=true -n aarellano-dev"
     // deploy image
     sh "oc new-app tasks:latest -n aarellano-dev"
     sh "oc expose svc/tasks -n aarellano-dev"
   }

   stage ('Deploy STAGE') {
     timeout(time:5, unit:'MINUTES') {
        input message: "Promote to STAGE?", ok: "Promote"
     }

     def v = version()
     // tag for stage
     sh "oc tag aarellano-dev/tasks:latest aarellano-stage/tasks:${v}"
     sh "oc project aarellano-stage"
     // clean up. keep the imagestream
     sh "oc delete bc,dc,svc,route -l app=tasks -n aarellano-stage"
     // deploy stage image
     sh "oc new-app tasks:${v} -n aarellano-stage"
     sh "oc expose svc/tasks -n aarellano-stage"
   }
}

def version() {
  def matcher = readFile('pom.xml') =~ '<version>(.+)</version>'
  matcher ? matcher[0][1] : null
}











[kitchensink-pipeline] Running shell script
+ mvn deploy -DskipTests=true -DaltDeploymentRepository= nexus::default::http://nexus.aarellano-cicd.svc.cluster.local:8081/repository/releases
[INFO] Scanning for projects...
[WARNING] 
[WARNING] Some problems were encountered while building the effective model for org.jboss.quickstarts.eap:jboss-kitchensink-angularjs:war:7.0-SNAPSHOT
[WARNING] 'build.plugins.plugin.version' for org.apache.maven.plugins:maven-clean-plugin is missing. @ line 261, column 19
[WARNING] 'build.plugins.plugin.version' for org.wildfly.plugins:wildfly-maven-plugin is missing. @ line 246, column 15
[WARNING] 
[WARNING] It is highly recommended to fix these problems because they threaten the stability of your build.
[WARNING] 
[WARNING] For this reason, future Maven versions might no longer support building such malformed projects.
[WARNING] 
Downloading: https://maven.repository.redhat.com/ga/nexus/default/http/default-http.pom

Downloading: https://repo.maven.apache.org/maven2/nexus/default/http/default-http.pom

[WARNING] The POM for nexus:default:jar:http is missing, no dependency information available
[INFO] ------------------------------------------------------------------------
[INFO] BUILD FAILURE
[INFO] ------------------------------------------------------------------------
[INFO] Total time: 9.005s
[INFO] Finished at: Thu Jun 22 15:30:39 UTC 2017
[INFO] Final Memory: 16M/564M
[INFO] ------------------------------------------------------------------------
[ERROR] Plugin nexus:default:http or one of its dependencies could not be resolved: Failed to read artifact descriptor for nexus:default:jar:http: Could not find artifact nexus:default:pom:http in jboss-enterprise-maven-repository (https://maven.repository.redhat.com/ga/) -> [Help 1]
[ERROR] 
[ERROR] To see the full stack trace of the errors, re-run Maven with the -e switch.
[ERROR] Re-run Maven using the -X switch to enable full debug logging.
[ERROR] 
[ERROR] For more information about the errors and possible solutions, please read the following articles:
[ERROR] [Help 1] http://cwiki.apache.org/confluence/display/MAVEN/PluginResolutionException
[Pipeline] }
[Pipeline] // stage
[Pipeline] }
[Pipeline] // node
[Pipeline] End of Pipeline
ERROR: script returned exit code 1
Finished: FAILURE



----------------- MY PIPELINE --------------------

// using openshift plugin commands
node('maven') {
   stage ('Build Phase') {
     git branch: 'dev-branch', url: 'https://github.com/AbrahamArellano/appdev-foundations-kitchensink.git'
     sh "mvn clean install -DskipTests=true"
   }
   
   stage ('Test Phase') {
      parallel (
         'Test': {
             sh "mvn test"
         },
         'Sonar': {
             sh "mvn sonar:sonar -Dsonar.host.url=http://sonarqube-aarellano-cicd.apps.emeabootcamp.openshift.opentlc.com -DskipTests=true"
         }
     )
    }
    
   stage ('Nexus integration') {
    sh "mvn -s nexus_settings.xml deploy -DskipTests=true"
   }
}

